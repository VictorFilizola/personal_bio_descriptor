@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthStateProvider
@inject AppState AppState

@* This using statement is required to find your auth provider *@
@using LE_Digital_2_Blazor_Server_WebApp.Server.Services
@using System.Security.Claims

<div class="header-container">
    <div class="header-left">
        @* This is the banner image you uploaded *@
        <img src="/images/logo.svg" alt="Company Banner" class="company-logo" />        <nav class="header-nav-menu">
            @* These are the links from your old NavMenu *@
            <AuthorizeView Roles="Director, Master">
                <NavLink class="nav-link" href="/director/dashboard" Match="NavLinkMatch.All">
                    <span class="oi oi-briefcase" aria-hidden="true"></span> Director
                </NavLink>
            </AuthorizeView>
            <AuthorizeView Roles="Manager, Master, Director">
                <NavLink class="nav-link" href="/manager/dashboard" Match="NavLinkMatch.All">
                    <span class="oi oi-person" aria-hidden="true"></span> Manager
                </NavLink>
            </AuthorizeView>
            <AuthorizeView Roles="Controller, Master">
                <NavLink class="nav-link" href="/controller/manage-versions" Match="NavLinkMatch.All">
                    <span class="oi oi-cog" aria-hidden="true"></span> Manage Versions
                </NavLink>
            </AuthorizeView>
        </nav>
    </div>

    <div class="user-info">
        @* This logic correctly displays the user's name and fixes the "white text" issue *@
        <AuthorizeView>
            <Authorized>
                @if (AppState.IsImpersonating)
                {
                    <span class="simulating-text">
                        Welcome, <strong>@(AppState.CurrentUser?.FindFirstValue("DisplayName"))</strong>
                        (Simulating <strong>@(AppState.ImpersonatedUser?.FindFirstValue("DisplayName"))</strong>)
                    </span>
                    <button class="btn btn-dark btn-sm ms-2" @onclick="StopImpersonation">
                        <span class="oi oi-x" aria-hidden="true"></span> Stop Simulating
                    </button>
                }
                else
                {
                    <span>
                        Welcome, <strong>@context.User.FindFirstValue("DisplayName")</strong>
                    </span>
                }
            </Authorized>
        </AuthorizeView>
    </div>
</div>

@code {
    private void StopImpersonation()
    {
        var customAuthProvider = (CustomAuthenticationStateProvider)AuthStateProvider;
        customAuthProvider.StopImpersonation();
        NavigationManager.NavigateTo("/");
    }
}